<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŠå¤©å®¤</title>
  <link rel="stylesheet" href="./styles/reset.css">
  <link rel="stylesheet" href="./styles/styles.css">
</head>
<body>
    <div class="chart-box">
      <div class="chart-con">
        

        <div class="create-name">
          <input type="text" id="name" class="name" placeholder="è¯·è¾“å…¥æƒ³åˆ›å»ºçš„æ˜µç§°">
          <div class="btn-group">
            <p id="setname" class="create create-btn">åˆ›å»ºæ˜µç§°</p>
            <p class="goback create-btn">é€€å‡ºèŠå¤©</p>
          </div>
        </div>

        <div class="send-msg" id="send-msg">
          <div class="bottom-con">
            <div class="emoji-box" id="emoji-box">
              <div class="emoji">
                <span class="s1">ğŸ˜€</span>
                <span class="s1">ğŸ˜</span>
                <span class="s1">ğŸ˜‚</span>
                <span class="s1">ğŸ˜ƒ</span>
                <span class="s1">ğŸ˜…</span>
                <span class="s1">ğŸ˜„</span>
                <span class="s1">ğŸ˜†</span>
                <span class="s1">ğŸ˜‰</span>
                <span class="s1">ğŸ˜Š</span>
                <span class="s1">ğŸ˜</span>
                <span class="s1">ğŸ˜</span>
                <span class="s1">ğŸ˜˜</span>
                <span class="s1">ğŸ˜—</span>
                <span class="s1">ğŸ˜š</span>
                <span class="s1">ğŸ˜</span>
                <span class="s1">ğŸ˜</span>
                <span class="s1">ğŸ˜£</span>
                <span class="s1">ğŸ˜¥</span>
                <span class="s1">ğŸ˜¶</span>
                <span class="s1">ğŸ˜‘</span>
                <span class="s1">ğŸ˜«</span>
                <span class="s1">ğŸ˜¯</span>
                <span class="s1">ğŸ˜’</span>
                <span class="s1">ğŸ˜</span>
                <span class="s1">ğŸ˜œ</span>
                <span class="s1">ğŸ˜Œ</span>
                <span class="s1">ğŸ˜¤</span>
                <span class="s1">ğŸ˜·</span>
                <span class="s1">ğŸ˜“</span>
                <span class="s1">ğŸ˜µ</span>
                <span class="s1">ğŸ˜³</span>
                <span class="s1">ğŸ˜¡</span>
                <span class="s1">ğŸ˜ </span>
                <span class="s1">ğŸ˜±</span>
                <span class="s1">ğŸ˜°</span>
                <span class="s1">ğŸ˜¬</span>
                <span class="s1">ğŸ˜¨</span>
                <span class="s1">ğŸ˜§</span>
                <span class="s1">ğŸ˜­</span>
                <span class="s1">ğŸ”ª</span>
                <span class="s1">âš½</span>
                <span class="s1">âš¡</span>
                <span class="s1">â­</span>
                <span class="s1">ğŸŒ</span>
                <span class="s1">ğŸŒ¼</span>
                <span class="s1">ğŸ‘€</span>
                <span class="s1">ğŸ‘…</span>
                <span class="s1">ğŸ’</span>
                <span class="s1">â“</span>
                <span class="s1">ğŸš©</span>
                <span class="s1">ğŸ˜ˆ</span>
                <span class="s1">ğŸš½</span>
                <span class="s1">ğŸŒœ</span>
                <span class="s1">ğŸš²</span>
                <span class="s1">âœˆ</span>
                <span class="s1">ğŸš€</span>
                <span class="s1">ğŸ‘¿</span>
              </div>
            </div>
            <div class="tools-box">
              <p class="emoji choose" id="choose">é€‰æ‹©è¡¨æƒ…</p>
            </div>
            <div class="msg-box">
              <textarea rows="3"  id="text" class="words" placeholder="è¯·è¾“å…¥" ></textarea>
              <p id="btn" class="send hide">å‘é€</p> 
            </div>
          </div>
        </div>
        <div id="container">

        </div>
      </div>
    </div>
    <p class="tips" id="tips">ç¾¤èŠè¯·å…ˆåˆ›å»ºè‡ªå®šä¹‰æ˜µç§°</p>

    <script>
    window.onload=function(){
      let choose = document.getElementById('choose');
      let emojiBox = document.getElementById('emoji-box');
      choose.onclick=function(){
        if(choose.innerHTML==='é€‰æ‹©è¡¨æƒ…'){
          emojiBox.classList.add('emoji-on');
          choose.innerHTML='é€€å‡ºé€‰æ‹©'
        }else{
          emojiBox.classList.remove('emoji-on');
          choose.innerHTML='é€‰æ‹©è¡¨æƒ…'
        }
      }

      let s1 = document.querySelectorAll('.s1');
      let textarea = document.getElementById('text');
      let currentValue = textarea.value;
      s1.forEach((current,index)=>{
        current.onclick=function(){
          console.log(current)
          console.log(current.innerHTML)
          var choosed = current.innerHTML;
          let newValue = currentValue +' '+choosed;
          textarea.value=current.innerHTML;
          emojiBox.classList.remove('emoji-on');
          choose.innerHTML='é€‰æ‹©è¡¨æƒ…'
        }
      })



      let yourName = localStorage.getItem('yourName');
      document.getElementById('name').value=yourName;

      document.querySelector('.goback').onclick=function(){
        window.location.href='./index.html'
      }

      var ws=null;
        
      document.getElementById('setname').onclick = function() {
         var name = document.getElementById('name').value;
          if(name === ''){
            let nameNotice = new Notification('æ¶ˆæ¯æç¤º', {
              body: 'è¯·å…ˆåˆ›å»ºæ˜µç§°'
            })
          }
          document.getElementById('tips').classList.add('tips-off');
          document.getElementById('send-msg').classList.add('send-on');
          ws = new WebSocket('ws://kolento.club:8001');
           
          //åœ¨å»ºç«‹è¿æ¥æ—¶ä¼šè§¦å‘
          ws.onopen = function(){
            //å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯
            ws.send(JSON.stringify({
                name:name,
                type:'setname'
            }));
          }

          document.getElementById('btn').onclick = send;
          document.getElementById('text').onkeyup = function(e) {
              if(e.keyCode !== 13) return;
              send();
          }
       
          //è‡ªåŠ¨æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„æ•°æ®
          //eä»£è¡¨ä¸€ä¸ªäº‹ä»¶  
          ws.onmessage = function(e){   
              var con = document.getElementById('container');
            
              //insertBefore(è¦æ’å…¥çš„å†…å®¹ï¼Œè¦æ’å…¥çš„ä½ç½®ä¹‹å‰)
              console.log(e.data)
            con.insertBefore(createChatPanel(JSON.parse(e.data)),con.children[0]);
          }
          //å°†åŠ å…¥æˆ¿é—´æŒ‰é’®è®¾ç½®ä¸å¯ç”¨ï¼ˆåªèƒ½åŠ å…¥ä¸€æ¬¡ï¼‰
          document.getElementById('setname').classList.add('hide');
      }

      function createChatPanel(data) {
        var name = data.name;
        var text = data.text;
        let currentName = localStorage.getItem('yourName');

        var div = document.createElement('div');
        var span1= document.createElement('p');
        var span2= document.createElement('p');
        name==currentName?span1.classList.add('me'):'';
        name==currentName?span2.classList.add('me'):'';

        span1.innerHTML = name+' '+new Date().format("yyyy-MM-dd hh:mm:ss");
        span2.innerHTML = text;

        span2.style.fontWeight = '900';

        div.appendChild(span1);
        div.appendChild(span2);
        if(name==currentName){
          //æ˜¯æˆ‘è‡ªå·±
        }else if(name=='Server'){
          let userNotice = new Notification(`åŠ å…¥é€šçŸ¥`, {
            body: text
          })
        }else{
          let userNotice = new Notification(`${name}å‘æ¥ä¸€æ¡æ¶ˆæ¯`, {
            body: text
          })
        }

        return div;
      }
      //å‘é€æ¶ˆæ¯
      function send() {
        var text=document.getElementById('text');
            if(text.value === '')return;
            ws.send(JSON.stringify({
              text:text.value,
              type:"chat"
        }));             
        text.value = '';
      }

      //Dateçš„åŸå‹ä¸­æ‰©å±•äº†formatæ–¹æ³•ï¼Œä½¿å…¶å¯ä»¥æ–¹ä¾¿çš„æ ¼å¼åŒ–æ—¥æœŸæ ¼å¼è¾“å‡ºã€‚
      Date.prototype.format = function(fmt) { 
        var o = { 
            "M+" : this.getMonth()+1,                 //æœˆä»½ 
            "d+" : this.getDate(),                    //æ—¥ 
            "h+" : this.getHours(),                   //å°æ—¶ 
            "m+" : this.getMinutes(),                 //åˆ† 
            "s+" : this.getSeconds(),                 //ç§’ 
            "q+" : Math.floor((this.getMonth()+3)/3), //å­£åº¦ 
            "S"  : this.getMilliseconds()             //æ¯«ç§’ 
        }; 
        if(/(y+)/.test(fmt)) {
                fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
        }
        for(var k in o) {
            if(new RegExp("("+ k +")").test(fmt)){
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
            }
        }
        return fmt; 
      }   
    }

    </script>
</body>
</html>